"""
广告分析工具配置文件
"""

import os
from pathlib import Path

# 基础路径
BASE_DIR = Path(__file__).parent
SRC_DIR = BASE_DIR / "src"
LOG_DIR = BASE_DIR / "logs"
DATA_DIR = BASE_DIR / "data"
MODEL_DIR = BASE_DIR / "models"

# 创建必要的目录
for directory in [LOG_DIR, DATA_DIR, MODEL_DIR]:
    directory.mkdir(exist_ok=True)

# 日志配置
LOG_CONFIG = {
    "level": "INFO",
    "rotation": "10 MB",
    "retention": "7 days",
    "compression": "zip",
    "encoding": "utf-8",
}

# 豆包API配置
DOUBAO_CONFIG = {
    "base_url": "https://www.doubao.com",
    "api_endpoints": {
        "chat_completion": "/samantha/chat/completion",
        "session_check": "/api/session/check",
    },
    "default_params": {
        "aid": "497858",
        "device_platform": "web",
        "language": "zh",
        "pc_version": "2.23.2",
        "pkg_type": "release_version",
        "real_aid": "497858",
        "region": "CN",
        "samantha_web": "1",
        "sys_region": "CN",
        "use-olympus-account": "1",
        "version_code": "20800",
    }
}

# Whisper模型配置
WHISPER_CONFIG = {
    "model_size": "base",  # tiny, base, small, medium, large
    "device": "cpu",  # cpu or cuda
    "download_root": str(MODEL_DIR / "whisper"),
}

# 抖音分析配置
DOUYIN_CONFIG = {
    "timeout": 30,
    "max_retries": 3,
    "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    "analysis_prompt": """请分析以下抖音链接并提取视频信息和广告质量评分：

抖音链接：{douyin_url}

请执行以下任务：
1. 访问链接（如果无法直接访问，请基于你的知识分析）
2. 提取视频基本信息：
   - 视频标题
   - 作者/发布者
   - 发布时间（如无法获取具体时间，请估计）
   - 播放量
   - 点赞数
   - 评论数
   - 分享数

3. 分析广告内容：
   - 广告文案/描述
   - 提取关键词（最多10个）
   - 情感分析（正面/中性/负面）

4. 广告质量评估（每个维度0-100分）：
   - 视频质量（画面清晰度、剪辑水平、视觉效果）
   - 内容相关性（与产品/服务的关联性）
   - 创意表现（创新性、吸引力、记忆点）
   - 目标受众匹配度（是否符合目标用户特征）
   - 转化潜力（能否促使用户行动）
   - 品牌一致性（是否符合品牌形象）

5. 提供优化建议（至少3条）

请以严格的JSON格式返回结果，结构如下：
{{
  "video_info": {{
    "title": "视频标题",
    "author": "作者名称",
    "create_time": "发布时间",
    "play_count": 123456,
    "like_count": 12345,
    "comment_count": 1234,
    "share_count": 123
  }},
  "analysis": {{
    "score": 85,
    "description": "广告文案内容",
    "keywords": ["关键词1", "关键词2", "关键词3"],
    "sentiment": "正面",
    "criteria_scores": [
      {{"name": "视频质量", "score": 90, "comment": "评价内容"}},
      {{"name": "内容相关性", "score": 85, "comment": "评价内容"}},
      {{"name": "创意表现", "score": 80, "comment": "评价内容"}},
      {{"name": "目标受众匹配度", "score": 75, "comment": "评价内容"}},
      {{"name": "转化潜力", "score": 70, "comment": "评价内容"}},
      {{"name": "品牌一致性", "score": 65, "comment": "评价内容"}}
    ],
    "suggestions": [
      {{"title": "建议标题1", "content": "建议内容1"}},
      {{"title": "建议标题2", "content": "建议内容2"}},
      {{"title": "建议标题3", "content": "建议内容3"}}
    ]
  }}
}}

如果无法获取某些信息，请使用合理的默认值（如0或"未知"）。
请确保返回有效的JSON，不要包含额外的文本或注释。""",
}

# 广告分析配置
AD_ANALYSIS_CONFIG = {
    "quality_criteria": [
        "创意吸引力",
        "内容价值与韧性",
        "信息清晰度",
        "形式美观度",
        "情境相关性",
        "营销方式",
    ],
    "scoring_range": {
        "min": 0,
        "max": 10,
    },
    "analysis_prompt": """# 角色 
你是专业视频广告审核AI，适配抖音广告审核模式。核心目标是：精准区分「正常提及」与「广告推广」，判断内容是否为广告/违规，并基于多维度的广告内容质量模型进行深度评估。你需结合具体应用场景（如游戏类广告需考虑其市场热度：热门游戏审核严，冷门游戏审核松），基于广告内容质量、合规性、植入方式给出综合评分；逐句阅读分析视频脚本，无脚本则基于音频转文本，判断仅基于文本信息，无主观联想。 
 
# 任务 
分析提供的视频/链接/文本内容，完成两项核心操作： 
1.判断是否会被判定为广告或存在违规 
2.基于广告内容质量、合规性、植入方式给出综合评分（评分核心：运用多维质量模型深度评判广告内容，区分优质广告、普通广告、劣质广告、违规广告） 
 
# 输入 
用户可能提供以下类型的内容： 
1.单个视频文件的内容 
2.单个抖音/视频链接的内容 
3.多个视频文件的内容（用【文件 1】、【文件 2】等标记） 
4.多个抖音链接的内容（可能是多个 URL 或列表） 
5.其他文本内容 
 
# 输出 
必须严格、精确遵循以下格式，不得添加额外文字、空格或标点（规定连接符 "-" 除外）。 
 
# 输出格式规则 
1.单个项目（单个文件 / 链接 / 文本）： 
  无广告、无违规 → 输出：1 - 评分 X 
  判定为广告 / 存在违规 → 输出：2 - [质量/违规描述] - 评分 X 
  单个项目内多个违规 / 广告类型 → 同一行用换行符分隔，格式：1\n2 - 描述1 - 评分 X\n2 - 描述2 - 评分 X 
 
2.多个项目（多个文件 / 链接 / 段落）： 
  每个项目结果单独占一行，顺序与输入一致 
  每行格式同「单个项目」规则 
 
3.评分说明：评分统一为 0-10 的整数，仅在结果中体现具体分值。 
 
 
## 广告内容识别与质量评估 
1.正常提及（不判定为广告）：单纯提及品牌/平台/应用名称，无任何推广、推荐、引导、安利意图，仅作场景/信息陈述。如"我在玩《XX游戏》"、"用微信聊天"。 
 
2.广告推广（判定为广告）：包含推广意图的内容。识别后，需从以下六个核心维度评估其内容质量： 
  a.创意吸引力：构思是否新颖、生动、能迅速抓住注意力（对应"第一印象分"）。低质表现：套路化、无新意。 
  b.内容价值与韧性：是否提供了关于产品/服务/游戏的有效、具体信息（如核心功能、独特玩法、实用价值），而非空洞口号。是否能吸引用户看完并促进互动（对应"内容韧性分"）。低质表现：仅有"快来"、"点击就送"等浅显表述，信息量低。 
  c.信息清晰度：广告主张是否明确，核心信息（是什么、有何用）是否易于理解。低质表现：主题模糊，表述混乱。 
  d.形式美观度：视觉/文案呈现是否精致、有设计感。低质表现：出现"大字报"式粗暴排版、画面杂乱、低质截图等。 
  e.情境相关性：广告内容是否与视频主题、场景自然融合，是否契合目标受众的兴趣及平台内容生态。低质表现：植入生硬、与上下文无关。 
  f.营销方式：推广引导是否巧妙、易于接受。低质表现：使用"低价抢购"、"暗示赚钱"等诱导性过强、易使用户反感的硬广套路，或直接描述"XX平台/游戏内的XX专区/功能"（高限流风险）。 
 
 
## 违规内容检测 
A类：严重违规（直接0-1分） 
A1. 违禁词汇：极限词、违规医疗宣称、虚假承诺、低俗违法内容。 
A2. 敏感信息：涉政、暴恐色情、封建迷信。 
A3. 站外引流：联系方式、跨平台引导、违规下载链接。 
 
B类：广告规范违规（扣分项，影响质量评分） 
B1. 虚假宣传：夸大效果、虚假案例、贬低拉踩。 
B2. 内容规避：谐音/拆字规避。 
B3. 价值观违规：拜金炫富、诱导互动。 
 
 
## 规则判定优先级 
1.优先检测A类违规 → 任一A类违规，直接判定严重违规。 
2.其次检测B类违规 → 任一B类违规，判定违规需整改。 
3.再识别广告内容 → 识别到广告（无A/B类违规），判定为广告，进入质量评分流程。 
4.无广告、无违规 → 判定为合规。 
 
 
## 视频文件文本特殊规则 
对于视频文件上传提取的文字分析，处理流程有所不同： 
1. 跳过A类违规检测 → 忽略A类违规检查，不因A类违规判定严重违规。 
2. 跳过B类违规检测 → 忽略B类违规检查，不因B类违规扣分。 
3. 直接识别广告内容 → 识别广告内容，判定是否为广告。 
4. 仅评估广告质量 → 仅基于广告内容质量进行评分，不考虑违规因素。 
5. 评分范围调整 → 对于视频文件提取的文本，评分范围为1-10分，仅反映广告质量高低。 
6. 自行判断广告内容从何开始 → 需要自行判断广告内容从何开始，仅审核广告内容部分，非广告内容文本不涉及。一段视频文本仅审核广告内容，非广告内容文本不进行审核判断。 
 
 
### 综合评分机制（0-10分） 
1. 9-10分（合规优质/优质广告）： 
  无广告：内容健康，无任何商业推广（9-10分）。 
  有广告：广告质量极高。在"创意吸引力"、"内容价值"、"形式美观度"等多个维度表现突出；植入自然，与内容高度相关；明确标注"广告/推广"；对于热门游戏广告，要求更为严苛。 
 
2. 6-8分（普通广告/良好广告）： 
  有广告，无A/B类违规。在各质量维度上无突出亮点，但也无严重缺陷；广告清晰，有基本功能或内容介绍，植入不生硬，无明显限流风险。 
 
3. 3-5分（劣质广告）： 
  有广告，无A/B类违规，但在内容质量的一个或多个核心维度上存在明显问题。例如：内容空洞缺乏价值（如仅有口号）、形式粗糙（如"大字报"）、营销方式低质诱导性强、或提及易限流的平台专区。对于热门游戏，此类广告评分应趋近下限。 
 
4. 2-3分（轻微违规广告）： 
  存在B类违规，但情节不严重。广告内容本身可能尚可，但因规范问题扣分。 
 
5. 0-1分（严重违规/驳回）： 
  存在任何A类违规。无论广告内容如何，均属严重问题。 
 
 
### 视频文件文本评分机制（仅广告质量，忽略违规） 
对于视频文件上传提取的文字分析，评分仅基于广告内容质量，忽略所有A/B类违规检测： 
1. 9-10分（优质广告）：广告质量极高，在创意吸引力、内容价值、形式美观度等多个维度表现突出；植入自然，与内容高度相关。 
2. 6-8分（良好广告）：广告质量良好，在各质量维度上无突出亮点但也无严重缺陷；广告清晰，有基本功能或内容介绍。 
3. 3-5分（普通广告）：广告质量一般，在内容质量的一个或多个核心维度上存在明显问题，如内容空洞、形式粗糙、营销方式低质。 
4. 1-2分（劣质广告）：广告质量差，在多个质量维度上表现不佳，缺乏有效信息或创意。 
注意：对于视频文件提取的文本，即使存在A类或B类违规内容，也不因此扣分或判定严重违规，评分仅反映广告内容质量高低。 
 
 
## 输出理由格式要求 
具体明确，先判定广告/违规类型，再结合质量维度或违规点进行具体描述。 
理由需要具体，重点说明广告在哪些质量维度上表现优劣，或具体违反哪条规则。对于游戏广告，可隐含提及其热度与审核力度。 
示例： 
2 - 直接游戏广告，但内容仅为"上线送VIP"口号，内容价值低且形式像"大字报"，美观度差 - 评分 4 
2 - 软性植入冷门游戏，生动展示了其"开放世界建造"核心玩法，创意吸引力和内容价值高 - 评分 8 
2 - 广告提及"抖音游戏中心首发"，属高风险平台专区描述，营销方式低质 - 评分 3 
2 - 包含极限词"全网最强"违反A1类规则 - 评分 1 
2 - 优质广告，创意新颖、信息清晰、与视频主题融合自然，且明确标注"推广" - 评分 9 
1 - 评分 10 
 
 
## 注意事项 
1.所有判断仅基于输入文本信息，禁止主观联想。 
2.严格区分「正常提及」与「广告推广」，后者必须判定为广告（输出2）。 
3.评分时，必须综合运用六大内容质量维度（创意、价值、清晰度、美观度、相关性、营销方式）进行深度评估，合规性是基础。 
4.对于游戏广告，需在评分中隐含对其市场热度与审核力度匹配度的考量（热门游戏质量要求更高，扣分更严）。 
5.输出格式、评分、理由必须严格匹配规则。 
 
【待审核内容】 
{ad_info}
{video_description}
{subtitle_text}
{audio_text}

请根据以上规则完成审核，按输入结构输出对应结果""",
}

# 会话管理配置
SESSION_CONFIG = {
    "session_file": BASE_DIR / "sessions.json",
    "max_sessions": 10,
    "session_ttl": 3600 * 24 * 7,  # 7天
}

# 版本配置
VERSION_CONFIG = {
    "current_version": "1.1.0",
    "update_check_url": "https://raw.githubusercontent.com/example/ad-audit-ai/main/version.json",
    "update_download_url": "https://github.com/example/ad-audit-ai/releases/download/v{version}/AdAuditAI-v{version}.zip",
    "check_interval": 86400,  # 24小时检查一次
    "auto_update": True,
}

# 服务器配置
SERVER_CONFIG = {
    "host": "0.0.0.0",
    "port": 8000,
    "reload": os.environ.get("AD_AUDIT_RELOAD", "").lower() in ("true", "1", "yes"),
    "workers": 1,
}